<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="UserDAO">

	<insert id="insertPs">
			INSERT INTO account (id,password) VALUES (#{id},#{password});
			INSERT INTO member VALUES ((SELECT MAX(mno) FROM account),#{name},#{phone},#{birth},#{address},#{email});
	</insert>
	<delete id="likeOff">
			DELETE FROM liked WHERE mno=#{mno} AND bno=#{bno};
	</delete>
	<insert id="insertBs" parameterType="business">
			INSERT INTO account (id,password) VALUES (#{id},#{password});
			INSERT INTO business (mno,bname,address,phone,bkno,acno,email,typeNum)  
			VALUES ((SELECT MAX(mno) FROM account),#{bname},#{address},#{phone},#{bankNum},#{bankAccountNum},#{email},#{bizType});
			
			<foreach collection="scheduleList" item="schedule"> <!-- 스케쥴 저장 -->
				INSERT INTO bsn_schedule VALUES ((SELECT MAX(bno) FROM business),${schedule.schno},'${schedule.time}');
			</foreach>
			
			<choose>
				<when test="bizType==1"> <!-- 일반세탁소라면 -->
				<foreach collection="laundryList" item="laundry">
					INSERT INTO bsn_laundry VALUES ((SELECT MAX(bno) FROM business),${laundry.lno},${laundry.price});
				</foreach>
				</when>
				<otherwise> <!-- else문,, 코인세탁소라면 -->
				<foreach collection="equipmentList" item="equipment">
					INSERT INTO bsn_equipment VALUES ((SELECT MAX(bno) FROM business),${equipment.eno},${equipment.cnt},${equipment.price});
				</foreach>
				<foreach collection="etcList" item="etc">
					INSERT INTO bsn_etc VALUES((SELECT MAX(bno) FROM business),${etc.etcno},${etc.price});
				</foreach>
				</otherwise>
			</choose>
	</insert>
	<update id="updatePs">
			<choose>
				<when test="name == null">
					UPDATE account SET password=#{password} WHERE mno=#{mno};
				</when>
				<otherwise>
					<!-- UPDATE account SET password=#{password} WHERE mno=#{mno}; -->
					UPDATE member SET mname=#{name},phone=#{phone},birth=#{birth},address=#{address},email=#{email} WHERE mno=#{mno};
				</otherwise>
			</choose>
	</update>

	<update id="updateSpec">
		<choose>
			<when test="bizType==1"> <!-- 일반세탁소라면 -->
				<foreach collection="laundryList" item="laundry">
					UPDATE bsn_laundry SET price=#{laundry.price} WHERE bno=#{bno} AND lno=#{laundry.lno};
				</foreach>
				<foreach collection="scheduleList" item="schedule">
					UPDATE bsn_schedule SET time=#{schedule.time} WHERE bno=#{bno} AND schno=#{schedule.schno};
				</foreach>
			</when>
			<otherwise> <!-- else문,, 코인세탁소라면 -->
				<foreach collection="equipmentList" item="equipment">
					UPDATE bsn_equipment SET cnt=#{equipment.cnt}, price=#{equipment.price} WHERE bno=#{bno} AND eno=#{equipment.eno};
				</foreach>
				<foreach collection="etcList" item="etc">
					  UPDATE bsn_etc SET price=#{etc.price} WHERE bno=#{bno} AND etcno=#{etc.etcno};
				</foreach>
				<foreach collection="scheduleList" item="schedule">
					UPDATE bsn_schedule SET time=#{schedule.time} WHERE bno=#{bno} AND schno=#{schedule.schno};
				</foreach>
				
			</otherwise>
		</choose>
	</update>

	<update id="updateBusiness">

	</update>
	<delete id="deleteUser">
			DELETE account WHERE mno=#{no}		
	</delete>
		<select id="getPerson" resultType="person">
		SELECT ac.mno as mno, id, password, mname as name, phone, birth, address,
		email
		FROM account ac, member mb
		WHERE ac.mno=mb.mno
		AND id=#{id} AND password=#{password};
	</select>
	<select id="getPersonBs" resultType="business">
		SELECT ac.mno as mno, bs.bno, id, password, bname, phone, address, email,
		bz.typenum, bkno, acno, ev.grade
		FROM account ac, business bs, biztype bz, Evaluation ev
		WHERE ac.mno=bs.mno
		AND bs.typeNum=bz.typenum
		AND id=#{id} AND password=#{password}
	</select>
	<select id="getPersonSNS" resultType="person">
		SELECT ac.mno as mno, id, password, mname as name, phone, birth, address,
		email
		FROM account ac, member mb
		WHERE ac.mno=mb.mno
		AND email=#{email};
	</select>
	<select id="getLikedBs" resultType="business">
		SELECT IFNULL(comm,0) commCount,IFNULL(eCount,0) eCount,l.bno bno,bname,IFNULL(ROUND(eval,1),0) eval,address,phone
		FROM business b ,liked l 
		LEFT OUTER JOIN (SELECT AVG(grade) eval,count(mno) eCount,bno FROM evaluation GROUP BY bno) e ON l.bno=e.bno 
		LEFT OUTER JOIN (SELECT count(mno) comm, bno FROM comments GROUP BY bno) c ON c.bno=e.bno
		WHERE l.bno=b.bno
		AND l.mno=#{mno}
		GROUP BY b.bno
		LIMIT 0,5;
	</select>
	<select id="countList" resultType="_int">
		SELECT count(bno) FROM liked WHERE mno=#{mno};
	</select>
	<!-- 관리자 페이지 기능이기 때문에 일단 대기.. -->
	<select id="getUserList">
		
	</select>
	<!-- 사양관리/설비관리 -->
	<select id="getLaundryList" resultType="laundry">
		SELECT bs.lno as lno, lname as laundry, price 
		FROM bsn_laundry bs, laundry_type la, business b 
		WHERE bs.lno=la.lno AND bs.bno=b.bno AND b.bno=#{bno};
	</select>
	<select id="getEquipmentList" resultType="equipment">
		SELECT eno, cnt, price FROM bsn_equipment WHERE bno= #{bno};
	</select>
	<select id="getEtc" resultType="etc">
		SELECT etcno, price FROM bsn_etc WHERE bno = #{bno};
	</select>
	<select id="getScheduleList" resultType="schedule">
		SELECT bs.schno, time 
		FROM bsn_schedule bs, schedule sc 
		WHERE bs.schno = sc.schno 
		AND bno=#{bno};
	</select>
	<select id="findId" resultType="account">

        <!-- SELECT * FROM account ac LEFT JOIN member mb on ac.mno=mb.mno LEFT 
            JOIN business bs on ac.mno=bs.mno WHERE (mname='테스트업체' AND mb.email='test@naver.com') 
            OR (bname='테스트업체' AND bs.email='test@naver.com'); -->
        SELECT id
        FROM account ac
        LEFT JOIN member mb on ac.mno=mb.mno
        LEFT JOIN business bs on ac.mno=bs.mno
        WHERE (mname=#{name} AND mb.email=#{email}) OR (bname=#{name} AND
        bs.email=#{email});
    </select>
</mapper>

